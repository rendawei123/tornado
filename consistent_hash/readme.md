### 分布式（一致性哈希）

##### 什么是分布式

如果我们将订单，session等信息存储在redis里面，如果用户量少了倒还好，如果用户量太大的话，一台机器是承受不了的，因此我们就要给他做分布式，也就是用多台机器安装redis同时给一个程序服务

##### 如何做？

一致性哈希

##### 什么是一致性哈希？

比如说我们有三台机器的redis提供服务，我们将三台机器的ip放在一个列表里面，表示第0台机器，第1台机器，第2台机器，每个用户过来访问的时候，我们都要给用户生成随机字符串，当用户携带随机字符串过来的时候我们将这些字符串转化成一个数字，让这个数字对3取余，这样每个用户经的随机字符串经过计算得到的结果可能是0，1，2，将结果为0的让第0台机器处理，结果为1的让第一台机器处理，结果为2的让第二台机器处理，这样就将用户分摊给了三台机器

##### 既然都是随机的，如何保证平均分摊？

绝对平均是保证不了的，但是如果某台机器的用户太少，比如第二台机器用户量太少，我们给他加权重，也就是将第二台机器的IP在列表里面写两遍，那么，让随机字符串给4取余，这样，第二台机器的概率就大大增加了

##### 这些都是你自己写的吗？

不是，是在网上找的模块，本来只支持python2，我将他修改成了python3

##### 配置

```python
from hash_ring import HashRing  # 一致性哈希模块

# 做分布式需要的三台机器的IP
memcache_servers = ['192.168.0.246:11212', '192.168.0.247:11212', '192.168.0.249:11212']
# 机器的权重
weights = {
    '192.168.0.246:11212': 2,
    '192.168.0.247:11212': 2,
    '192.168.0.249:11212': 1
}

ring = HashRing(memcache_servers, weights)
result = ring.get_node('03d025bb5ac29c24c9ca2257634b9b85b2454fb2')
print(result)  # result哪一台机器
```

